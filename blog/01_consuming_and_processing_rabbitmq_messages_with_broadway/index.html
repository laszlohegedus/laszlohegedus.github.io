<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://laszlohegedus.com/blog/01_consuming_and_processing_rabbitmq_messages_with_broadway/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Consuming and Processing RabbitMQ Messages with Broadway - László Hegedüs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">László Hegedüs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Blog <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Consuming and Processing RabbitMQ Messages with Broadway</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <a rel="prev" href="../.." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#consuming-and-processing-rabbitmq-messages-with-broadway" class="nav-link">Consuming and Processing RabbitMQ Messages with Broadway</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#starting-up-and-basic-configuration" class="nav-link">Starting Up and Basic Configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#metadata" class="nav-link">Metadata</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#message-acknowledgements" class="nav-link">Message Acknowledgements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="consuming-and-processing-rabbitmq-messages-with-broadway">Consuming and Processing RabbitMQ Messages with Broadway</h1>
<p>I recently got the chance to work with RabbitMQ again and the team decided to give BroadwayRabbitMQ a go. The online documentation is good enough to get up and running, but I would like to share a few tips and tricks. Introducing RabbitMQ and Broadway is not covered in this post, I assume that the reader is familiar enough with them.</p>
<h2 id="starting-up-and-basic-configuration">Starting Up and Basic Configuration</h2>
<p>In order to process messages coming from RabbitMQ, we need to write a <code>Broadway</code> module that specifies <code>BroadwayRabbitMQ.Producer</code> as its producer:</p>
<pre><code class="language-elixir">defmodule RabbitmqBlog.Processor do
  use Broadway

  alias Broadway.Message

  def start_link(_opts) do
    producer_config =
      Application.get_env(:rabbitmq_blog, :rabbitmq_broadway_producer)
      |&gt; Keyword.put(:queue, &quot;rabbitmq.blog&quot;)

    Broadway.start_link(__MODULE__,
      name: __MODULE__,
      producer: [
        module: {BroadwayRabbitMQ.Producer, producer_config},
        stages: 2
      ],
      processors: [
        default: [
          stages: 50
        ]
      ]
    )
  end

  def handle_message(_, message, _) do
    IO.inspect(message.data, label: &quot;Got message&quot;)
    message
  end
end

</code></pre>
<p>Where <code>:rabbitmq_broadway_producer</code> is defined in <code>config.exs</code> as follows:</p>
<pre><code class="language-elixir">config :rabbitmq_blog, :rabbitmq_broadway_producer,
  connection: [
    host: System.get_env(&quot;RABBITMQ_HOST&quot;),
    port: String.to_integer(System.get_env(&quot;RABBITMQ_PORT&quot;, &quot;5672&quot;)),
    username: System.get_env(&quot;RABBITMQ_USERNAME&quot;),
    password: System.get_env(&quot;RABBITMQ_PASSWORD&quot;)
  ]
</code></pre>
<p>The value of <code>connection</code> is passed on to <a href="https://hexdocs.pm/amqp/AMQP.Connection.html#open/1">AMQP.Connection.open/1</a>. See its documentation for the available options.</p>
<p>Storing the config in <code>config.exs</code> (or rather <code>releases.exs</code>) is my preferred choice, but not the only way. It gives a convenient way of reading secrets from environment variables in production.</p>
<p>If we start our app now and open the RabbitMQ Management UI, we can see that the Broadway producer created two connections with one channel on each connection. This is pretty much expected, as the number of connections depend on the number of stages.</p>
<h3 id="queue-declare-options-and-bindings">Queue declare options and bindings</h3>
<p>I strongly believe that creating the queues and bindings in RabbitMQ is the responsibility of consumers and it should happen inside the application. This is pretty well supported by <code>BroadwayRabbitMQ</code> by the <code>:declare</code> and <code>:bindings</code> options that we can pass to the producer.</p>
<p>Consult <a href="https://hexdocs.pm/amqp/AMQP.Queue.html#declare/3">AMQP.Queue.declare/3</a> for the options that you can pass in <code>:declare</code>.</p>
<p>For example, we can make <code>BroadwayRabbitMQ.Producer</code> take care of declaring the queue for us, if we add the <code>:declare</code> option to its config:</p>
<pre><code class="language-elixir">producer_config =
  producer_config
  |&gt; Keyword.put(:declare, [
      durable: false,
      arguments: [{&quot;x-message-ttl&quot;, :long, 10_000}] # 10 seconds
    ])
</code></pre>
<p>The option <code>:bindings</code> is useful, if the routing logic is more or less static and does not involve exchange-to-exchange bindings. Each binding is a pair <code>{exchange_name, binding_options}</code> and they are passed to <a href="https://hexdocs.pm/amqp/AMQP.Queue.html#bind/4">AMQP.Queue.bind/4</a>. For example, <code>{"amq.direct", [routing_key: "blog-messages"]}</code> declares that a binding should be created from the exchange <code>amq.direct</code> to the queue <code>rabbitmq.blog</code> via routing key <code>blog-messages</code>:</p>
<pre><code class="language-elixir">producer_config =
  producer_config
  |&gt; Keyword.put(:bindings, [
      {&quot;amq.direct&quot;, [routing_key: &quot;blog-messages&quot;]}
    ])
</code></pre>
<h2 id="metadata">Metadata</h2>
<p>By default the processors receive only the body of the message in the <code>:data</code> field of <code>Broadway.Message</code>. This may be enough if the body contains all the information that is required for processing it, but RabbitMQ exposes several additional fields on the message. To see them, we have to specify the <code>:metadata</code> option as a list of atoms when configuring the producer. In general most of the option names from <a href="https://hexdocs.pm/amqp/AMQP.Basic.html#publish/5-options">AMQP.Basic.publish/5</a> can be used, except for the special flags <code>:mandatory</code> and <code>:immediate</code>. In addition to basic publish metadata the server adds the following information: <code>:cluster_id</code>, <code>:consumer_tag</code>, <code>:delivery_tag</code>, <code>:exchange</code>, <code>:redelivered</code>, <code>:routing_key</code>.</p>
<p>For example, if we need <code>:routing_key</code> to process the message, we should state it in the processor config:</p>
<pre><code class="language-elixir">producer_config =
  producer_config
  |&gt; Keyword.put(:metadata, [
      :routing_key
    ])
</code></pre>
<h2 id="message-acknowledgements">Message Acknowledgements</h2>
<p>To configure how our <code>BroadwayRabbitMQ</code> producer should handle message acknowledgements we can specify the options <code>:on_success</code> and/or <code>:on_failure</code>. Their values can be <code>:ack</code>, <code>:reject</code>, <code>:reject_and_requeue</code>, <code>:reject_and_requeue_once</code>. Chosing the right method can be difficult. In general, setting <code>:on_success</code> to <code>:ack</code> makes sense, if <code>handle_message</code> returns successfully only when the message is actually processed. Deciding when to requeue a message is more complicated, since we cannot always be sure why processing failed. Logging and thorough testing comes handy. It also matters whether our application is prepared to handle duplicate messages, which I strongly recommend to take into account.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>

        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
