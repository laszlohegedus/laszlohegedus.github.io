
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://laszlohegedus.com/blog/01_consuming_and_processing_rabbitmq_messages_with_broadway/">
      
      <link rel="icon" href="../../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.10">
    
    
      
        <title>Consuming and Processing RabbitMQ Messages with Broadway - László Hegedüs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1fe995fd.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/prism.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#consuming-and-processing-rabbitmq-messages-with-broadway" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="László Hegedüs" class="md-header__button md-logo" aria-label="László Hegedüs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            László Hegedüs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Consuming and Processing RabbitMQ Messages with Broadway
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="László Hegedüs" class="md-nav__button md-logo" aria-label="László Hegedüs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    László Hegedüs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Blog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../contact/" class="md-nav__link">
        Contact
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#starting-up-and-basic-configuration" class="md-nav__link">
    Starting Up and Basic Configuration
  </a>
  
    <nav class="md-nav" aria-label="Starting Up and Basic Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queue-declare-options-and-bindings" class="md-nav__link">
    Queue declare options and bindings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metadata" class="md-nav__link">
    Metadata
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-acknowledgements" class="md-nav__link">
    Message Acknowledgements
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="consuming-and-processing-rabbitmq-messages-with-broadway">Consuming and Processing RabbitMQ Messages with Broadway</h1>
<p><code>2020-01-15</code></p>
<p>I recently got the chance to work with RabbitMQ again and the team decided to give BroadwayRabbitMQ a go. The online documentation is good enough to get up and running, but I would like to share a few tips and tricks. Introducing RabbitMQ and Broadway is not covered in this post, I assume that the reader is familiar enough with them.</p>
<h2 id="starting-up-and-basic-configuration">Starting Up and Basic Configuration</h2>
<p>In order to process messages coming from RabbitMQ, we need to write a <code>Broadway</code> module that specifies <code>BroadwayRabbitMQ.Producer</code> as its producer:</p>
<pre><code class="language-elixir">defmodule RabbitmqBlog.Processor do
  use Broadway

  alias Broadway.Message

  def start_link(_opts) do
    producer_config =
      Application.get_env(:rabbitmq_blog, :rabbitmq_broadway_producer)
      |&gt; Keyword.put(:queue, &quot;rabbitmq.blog&quot;)

    Broadway.start_link(__MODULE__,
      name: __MODULE__,
      producer: [
        module: {BroadwayRabbitMQ.Producer, producer_config},
        stages: 2
      ],
      processors: [
        default: [
          stages: 50
        ]
      ]
    )
  end

  def handle_message(_, message, _) do
    IO.inspect(message.data, label: &quot;Got message&quot;)
    message
  end
end

</code></pre>
<p>Where <code>:rabbitmq_broadway_producer</code> is defined in <code>config.exs</code> as follows:</p>
<pre><code class="language-elixir">config :rabbitmq_blog, :rabbitmq_broadway_producer,
  connection: [
    host: System.get_env(&quot;RABBITMQ_HOST&quot;),
    port: String.to_integer(System.get_env(&quot;RABBITMQ_PORT&quot;, &quot;5672&quot;)),
    username: System.get_env(&quot;RABBITMQ_USERNAME&quot;),
    password: System.get_env(&quot;RABBITMQ_PASSWORD&quot;)
  ]
</code></pre>
<p>The value of <code>connection</code> is passed on to <a href="https://hexdocs.pm/amqp/AMQP.Connection.html#open/1">AMQP.Connection.open/1</a>. See its documentation for the available options.</p>
<p>Storing the config in <code>config.exs</code> (or rather <code>releases.exs</code>) is my preferred choice, but not the only way. It gives a convenient way of reading secrets from environment variables in production.</p>
<p>If we start our app now and open the RabbitMQ Management UI, we can see that the Broadway producer created two connections with one channel on each connection. This is pretty much expected, as the number of connections depend on the number of stages.</p>
<h3 id="queue-declare-options-and-bindings">Queue declare options and bindings</h3>
<p>I strongly believe that creating the queues and bindings in RabbitMQ is the responsibility of consumers and it should happen inside the application. This is pretty well supported by <code>BroadwayRabbitMQ</code> by the <code>:declare</code> and <code>:bindings</code> options that we can pass to the producer.</p>
<p>Consult <a href="https://hexdocs.pm/amqp/AMQP.Queue.html#declare/3">AMQP.Queue.declare/3</a> for the options that you can pass in <code>:declare</code>.</p>
<p>For example, we can make <code>BroadwayRabbitMQ.Producer</code> take care of declaring the queue for us, if we add the <code>:declare</code> option to its config:</p>
<pre><code class="language-elixir">producer_config =
  producer_config
  |&gt; Keyword.put(:declare, [
      durable: false,
      arguments: [{&quot;x-message-ttl&quot;, :long, 10_000}] # 10 seconds
    ])
</code></pre>
<p>The option <code>:bindings</code> is useful, if the routing logic is more or less static and does not involve exchange-to-exchange bindings. Each binding is a pair <code>{exchange_name, binding_options}</code> and they are passed to <a href="https://hexdocs.pm/amqp/AMQP.Queue.html#bind/4">AMQP.Queue.bind/4</a>. For example, <code>{"amq.direct", [routing_key: "blog-messages"]}</code> declares that a binding should be created from the exchange <code>amq.direct</code> to the queue <code>rabbitmq.blog</code> via routing key <code>blog-messages</code>:</p>
<pre><code class="language-elixir">producer_config =
  producer_config
  |&gt; Keyword.put(:bindings, [
      {&quot;amq.direct&quot;, [routing_key: &quot;blog-messages&quot;]}
    ])
</code></pre>
<h2 id="metadata">Metadata</h2>
<p>By default the processors receive only the body of the message in the <code>:data</code> field of <code>Broadway.Message</code>. This may be enough if the body contains all the information that is required for processing it, but RabbitMQ exposes several additional fields on the message. To see them, we have to specify the <code>:metadata</code> option as a list of atoms when configuring the producer. In general most of the option names from <a href="https://hexdocs.pm/amqp/AMQP.Basic.html#publish/5-options">AMQP.Basic.publish/5</a> can be used, except for the special flags <code>:mandatory</code> and <code>:immediate</code>. In addition to basic publish metadata the server adds the following information: <code>:cluster_id</code>, <code>:consumer_tag</code>, <code>:delivery_tag</code>, <code>:exchange</code>, <code>:redelivered</code>, <code>:routing_key</code>.</p>
<p>For example, if we need <code>:routing_key</code> to process the message, we should state it in the processor config:</p>
<pre><code class="language-elixir">producer_config =
  producer_config
  |&gt; Keyword.put(:metadata, [
      :routing_key
    ])
</code></pre>
<h2 id="message-acknowledgements">Message Acknowledgements</h2>
<p>To configure how our <code>BroadwayRabbitMQ</code> producer should handle message acknowledgements we can specify the options <code>:on_success</code> and/or <code>:on_failure</code>. Their values can be <code>:ack</code>, <code>:reject</code>, <code>:reject_and_requeue</code>, <code>:reject_and_requeue_once</code>. Chosing the right method can be difficult. In general, setting <code>:on_success</code> to <code>:ack</code> makes sense, if <code>handle_message</code> returns successfully only when the message is actually processed. Deciding when to requeue a message is more complicated, since we cannot always be sure why processing failed. Logging and thorough testing comes handy. It also matters whether our application is prepared to handle duplicate messages, which I strongly recommend to take into account.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
        <script src="../../js/prism.js"></script>
      
    
  </body>
</html>